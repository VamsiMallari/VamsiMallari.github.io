<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Chess Puzzle Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, min(8vw, 60px));
            grid-template-rows: repeat(8, min(8vw, 60px));
            border: 4px solid #374151;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .chess-square {
            width: min(8vw, 60px);
            height: min(8vw, 60px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: min(6vw, 36px);
            cursor: pointer;
            position: relative;
        }
        .light-square { background-color: #f0d9b5; }
        .dark-square { background-color: #b58863; }
        .selected { box-shadow: inset 0 0 0 4px #10b981; }
        .possible-move::after {
            content: '';
            position: absolute;
            width: 30%;
            height: 30%;
            background-color: #10b981;
            border-radius: 50%;
            opacity: 0.6;
        }
        .tab-active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.2);
        }
        #auth-modal.opacity-0 { visibility: hidden; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full mx-4" id="auth-box">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">â™” Chess Puzzle Master â™›</h2>
            <div id="login-form">
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <button type="submit" class="w-full py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors shadow-md">Login</button>
                </form>
                <div class="text-center mt-4 text-sm">
                    <button onclick="handlePasswordReset()" class="text-gray-500 hover:underline">Forgot Password?</button>
                </div>
                <p class="text-center mt-2 text-gray-600">No account? <button onclick="showRegister()" class="text-indigo-600 hover:underline font-semibold">Register</button></p>
            </div>
            <div id="register-form" class="hidden">
                <form onsubmit="handleRegister(event)" class="space-y-4">
                    <input type="text" id="register-name" placeholder="Full Name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="email" id="register-email" placeholder="Email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="register-password" placeholder="Password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <button type="submit" class="w-full py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors shadow-md">Register</button>
                </form>
                <p class="text-center mt-4 text-gray-600">Have an account? <button onclick="showLogin()" class="text-indigo-600 hover:underline font-semibold">Login</button></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden opacity-0 transition-opacity duration-500">
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800">Chess Puzzle Master</h1>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-700">Welcome, <span id="user-name" class="font-semibold">User</span></span>
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 shadow-sm">Logout</button>
                </div>
            </div>
        </header>

        <nav class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
            <div class="flex space-x-2 bg-white rounded-lg p-1 shadow-sm">
                <button onclick="showTab('solve')" id="solve-tab" class="tab-active flex-1 py-2 px-4 rounded-md font-medium text-sm sm:text-base">ðŸ§© Solve Puzzles</button>
                <button onclick="showTab('dashboard')" id="dashboard-tab" class="flex-1 py-2 px-4 rounded-md font-medium text-sm sm:text-base text-gray-600 hover:bg-gray-100">ðŸ“Š Dashboard</button>
                <button onclick="showTab('create')" id="create-tab" class="flex-1 py-2 px-4 rounded-md font-medium text-sm sm:text-base text-gray-600 hover:bg-gray-100">âž• Create Puzzle</button>
            </div>
        </nav>

        <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="solve-content" class="tab-content">
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="flex-grow flex justify-center">
                        <div class="chess-board" id="chess-board"></div>
                    </div>
                    <div class="lg:w-80 flex-shrink-0 space-y-6">
                        <div class="bg-white rounded-lg shadow p-5">
                            <h2 class="text-xl font-bold text-gray-800" id="puzzle-title">Select a Puzzle</h2>
                            <p class="text-gray-600 text-sm mt-1" id="puzzle-description">Choose a puzzle from the dashboard to start.</p>
                            <div class="mt-4 flex space-x-2">
                                <button onclick="startSolving()" id="solve-btn" class="w-full py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold shadow-sm">Solve</button>
                                <button onclick="submitSolution()" id="submit-btn" class="w-full py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold shadow-sm hidden">Submit</button>
                                <button onclick="resetPuzzle()" class="py-2 px-4 bg-gray-500 text-white rounded-lg hover:bg-gray-600 shadow-sm">Reset</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5">
                            <h3 class="font-bold text-gray-700 mb-2">Game Info</h3>
                            <div class="space-y-1 text-sm">
                                <p><strong>Status:</strong> <span id="game-status">Ready</span></p>
                                <p><strong>Turn:</strong> <span id="player-turn-display">N/A</span></p>
                                <p><strong>Time:</strong> <span id="timer" class="font-bold">00:00</span></p>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5">
                            <h3 class="font-bold text-gray-700 mb-2">Move History</h3>
                            <div class="bg-gray-50 rounded p-2 min-h-[80px] text-sm" id="move-history"><p class="text-gray-500">No moves yet.</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="dashboard-content" class="tab-content hidden bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Puzzle Collection</h2>
                <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4" id="puzzle-grid"><p>Loading puzzles...</p></div>
            </div>

            <div id="create-content" class="tab-content hidden">
                <div id="admin-check" class="bg-white rounded-lg shadow p-6 max-w-md mx-auto">
                    <h2 class="text-xl font-bold mb-4">Admin Access</h2>
                    <input type="password" id="admin-password" placeholder="Enter admin password" class="w-full p-2 border rounded mb-2">
                    <button onclick="checkAdminPassword()" class="w-full py-2 bg-indigo-600 text-white rounded font-semibold">Verify</button>
                </div>
                <div id="create-form" class="hidden bg-white rounded-lg shadow p-6 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4">Create New Puzzle</h2>
                    <p class="text-sm text-gray-600 mb-4">Get the FEN string for your puzzle from an editor like lichess.org/editor.</p>
                    <form id="puzzle-form" class="space-y-3">
                        <input type="text" id="new-title" class="w-full p-2 border rounded" placeholder="Puzzle Title (e.g., anand-vs-carlsen-2013)">
                        <textarea id="new-description" class="w-full p-2 border rounded" placeholder="Description (e.g., Find the winning move for White)"></textarea>
                        <input type="text" id="new-fen" class="w-full p-2 border rounded" placeholder="FEN String (e.g., r1bqkbnr/pppp1ppp/... w KQkq - 0 1)">
                        <input type="text" id="new-solution" class="w-full p-2 border rounded" placeholder="Solution moves (UCI or SAN, e.g., e2e4 or e2e4,g1f3)">
                        <button type="button" onclick="savePuzzle()" class="w-full py-2 bg-green-600 text-white rounded font-semibold">Save Puzzle</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCuSurKpIMGQv8-yu4txJE_8_KZk5lSJ3w",
            authDomain: "chess-puzzels-rkv.firebaseapp.com",
            projectId: "chess-puzzels-rkv",
            storageBucket: "chess-puzzels-rkv.firebasestorage.app",
            messagingSenderId: "130806565295",
            appId: "1:130806565295:web:6f09088b2072e815ecc75a",
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const PIECE_SYMBOLS = {
            'K': 'â™”', 'Q': 'â™•', 'R': 'â™–', 'B': 'â™—', 'N': 'â™˜', 'P': 'â™™',
            'k': 'â™š', 'q': 'â™›', 'r': 'â™œ', 'b': 'â™', 'n': 'â™ž', 'p': 'â™Ÿ'
        };

        let currentBoard = [];
        let selectedSquare = null;
        let gameState = 'ready';
        let currentPuzzle = null;
        let currentUser = null;
        let moveHistory = []; // array of UCI moves like ["e2e4","e7e5"]
        let playerTurn = 'w';
        let canMove = false;
        let timerInterval = null;
        let startTime = null;

        // --- Auth Functions ---
        const showLogin = () => {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
        };
        const showRegister = () => {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        };
        const handleLogin = async e => {
            e.preventDefault();
            try { await auth.signInWithEmailAndPassword(e.target['login-email'].value, e.target['login-password'].value); }
            catch (err) { alert(err.message); }
        };
        const handleRegister = async e => {
            e.preventDefault();
            const name = e.target['register-name'].value;
            const email = e.target['register-email'].value;
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, e.target['register-password'].value);
                await db.collection('users').doc(cred.user.uid).set({ name, email, solvedCount: 0 });
            } catch (err) { alert(err.message); }
        };
        const logout = () => auth.signOut();
        const handlePasswordReset = () => {
            const email = prompt("Please enter your email address to reset your password:");
            if (email) {
                auth.sendPasswordResetEmail(email)
                    .then(() => { alert("Password reset email sent! Please check your inbox."); })
                    .catch((error) => { alert("Error: " + error.message); });
            }
        };

        auth.onAuthStateChanged(async (user) => {
            const authModal = document.getElementById('auth-modal');
            const mainApp = document.getElementById('main-app');
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        document.getElementById('user-name').textContent = userDoc.data().name;
                    }
                    await loadPuzzles();

                    authModal.classList.add('opacity-0');
                    mainApp.classList.remove('hidden');
                    setTimeout(() => {
                        authModal.style.display = 'none';
                        mainApp.classList.remove('opacity-0');
                    }, 300);

                } catch (error) {
                    console.error("Error loading user data or puzzles:", error);
                    alert("Could not load necessary data. Please try again.");
                    logout();
                }
            } else {
                currentUser = null;
                authModal.style.display = 'flex';
                mainApp.classList.add('hidden', 'opacity-0');
                setTimeout(() => authModal.classList.remove('opacity-0'), 50);
            }
        });

        // --- Tab Management ---
        const showTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('[id$="-tab"]').forEach(t => {
                t.classList.remove('tab-active', 'text-white');
                t.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            const tab = document.getElementById(`${tabName}-tab`);
            tab.classList.add('tab-active', 'text-white');
            tab.classList.remove('text-gray-600', 'hover:bg-gray-100');
        };

        // --- Chess Board Logic ---
        const createBoardFromFEN = (fen) => {
            const board = Array(8).fill(null).map(() => Array(8).fill(''));
            if (!fen || typeof fen !== 'string') return board;

            const [position] = fen.split(' ');
            const ranks = position.split('/');
            for (let rank = 0; rank < 8; rank++) {
                let file = 0;
                for (const char of ranks[rank]) {
                    if (isNaN(char)) {
                        board[rank][file] = char;
                        file++;
                    } else {
                        file += parseInt(char);
                    }
                }
            }
            return board;
        };

        const renderBoard = (board) => {
            const container = document.getElementById('chess-board');
            container.innerHTML = '';
            currentBoard = board;
            for (let rank = 0; rank < 8; rank++) {
                for (let file = 0; file < 8; file++) {
                    const square = document.createElement('div');
                    square.className = `chess-square ${(rank + file) % 2 === 0 ? 'light-square' : 'dark-square'}`;
                    square.dataset.rank = rank;
                    square.dataset.file = file;
                    const piece = board[rank][file];
                    if (piece) square.textContent = PIECE_SYMBOLS[piece] || '';
                    square.addEventListener('click', () => handleSquareClick(rank, file));
                    container.appendChild(square);
                }
            }
        };

        // --- Puzzle Loading ---
        const loadPuzzles = async () => {
            try {
                const snapshot = await db.collection('puzzles').get();
                const puzzles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const grid = document.getElementById('puzzle-grid');
                grid.innerHTML = '';
                puzzles.forEach(puzzle => {
                    const card = document.createElement('div');
                    card.className = "p-4 border rounded-lg cursor-pointer hover:bg-gray-100 hover:shadow-md transition-shadow";
                    card.innerHTML = `<h3 class="font-bold text-gray-800">${puzzle.title || 'Untitled'}</h3><p class="text-sm text-gray-600">${puzzle.description || ''}</p>`;
                    card.onclick = () => { showTab('solve'); loadPuzzle(puzzle); };
                    grid.appendChild(card);
                });
            } catch (err) {
                console.error("Error loading puzzles:", err);
                document.getElementById('puzzle-grid').innerHTML = `<p class="text-red-600">Failed to load puzzles. See console for details.</p>`;
            }
        };

        const loadPuzzle = (puzzle) => {
            if (!puzzle.fen) {
                alert(`Error: The puzzle "${puzzle.title}" is missing the required 'fen' field in the database. Please update the puzzle with a valid FEN string.`);
                renderBoard(createBoardFromFEN(null));
                return;
            }
            currentPuzzle = puzzle;

            const board = createBoardFromFEN(puzzle.fen);
            renderBoard(board);

            playerTurn = puzzle.fen.split(' ')[1] || 'w';

            document.getElementById('puzzle-title').textContent = puzzle.title || 'Untitled Puzzle';
            document.getElementById('puzzle-description').textContent = puzzle.description || '';
            resetGameState();
        };

        const resetGameState = () => {
            gameState = 'ready';
            moveHistory = [];
            canMove = false;
            selectedSquare = null;
            clearInterval(timerInterval);
            startTime = null;
            document.getElementById('timer').textContent = '00:00';
            document.getElementById('game-status').textContent = 'Ready';
            document.getElementById('player-turn-display').textContent = `${playerTurn === 'w' ? 'White' : 'Black'}`;
            document.getElementById('move-history').innerHTML = `<p class="text-gray-500">Click Solve to begin.</p>`;
            document.getElementById('solve-btn').classList.remove('hidden');
            document.getElementById('submit-btn').classList.add('hidden');
        };

        const resetPuzzle = () => {
            if (currentPuzzle) loadPuzzle(currentPuzzle);
        };

        // --- Game Interaction ---
        const startSolving = () => {
            if (!currentPuzzle) { alert("Please select a puzzle first."); return; }
            canMove = true;
            gameState = 'playing';
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = `${String(Math.floor(elapsed/60)).padStart(2,'0')}:${String(elapsed%60).padStart(2,'0')}`;
            }, 1000);
            document.getElementById('game-status').textContent = 'In Progress';
            document.getElementById('solve-btn').classList.add('hidden');
            document.getElementById('submit-btn').classList.remove('hidden');
        };

        const handleSquareClick = (rank, file) => {
            if (!canMove) return;
            const piece = currentBoard[rank][file];
            const isWhitePiece = piece && piece.toUpperCase() === piece;
            const isBlackPiece = piece && piece.toLowerCase() === piece;
            const isMyTurn = (playerTurn === 'w' && isWhitePiece) || (playerTurn === 'b' && isBlackPiece);

            if (selectedSquare) {
                const fromRank = selectedSquare.rank;
                const fromFile = selectedSquare.file;
                const movedPiece = currentBoard[fromRank][fromFile];
                currentBoard[rank][file] = movedPiece;
                currentBoard[fromRank][fromFile] = '';
                renderBoard(currentBoard);

                // Simple UCI move (from-to): e.g., "e2e4"
                const moveUCI = `${String.fromCharCode(97+fromFile)}${8-fromRank}${String.fromCharCode(97+file)}${8-rank}`;
                moveHistory.push(moveUCI);
                updateMoveHistory();

                playerTurn = playerTurn === 'w' ? 'b' : 'w';
                document.getElementById('player-turn-display').textContent = `${playerTurn === 'w' ? 'White' : 'Black'}`;

                selectedSquare = null;
                document.querySelectorAll('.selected').forEach(s => s.classList.remove('selected'));
            } else if (piece && isMyTurn) {
                selectedSquare = { rank, file };
                document.querySelector(`[data-rank="${rank}"][data-file="${file}"]`).classList.add('selected');
            }
        };

        const updateMoveHistory = () => {
            const historyDiv = document.getElementById('move-history');
            let html = '';
            for (let i = 0; i < moveHistory.length; i += 2) {
                html += `<div class="flex justify-between"><span class="font-mono text-xs">${(i/2)+1}.</span> <span class="font-mono text-sm">${moveHistory[i]}</span> <span class="font-mono text-sm">${moveHistory[i+1] || ''}</span></div>`;
            }
            historyDiv.innerHTML = html || `<p class="text-gray-500">No moves yet.</p>`;
        };

        // --- Helper: normalize solution representation into array of UCI moves ---
        const normalizeSolution = (val) => {
            if (!val) return [];
            if (Array.isArray(val)) return val.map(v => (''+v).trim()).filter(Boolean);

            // val is a string:
            const s = (''+val).trim();
            // if contains comma or space -> split
            if (s.includes(',') || s.includes(' ')) {
                return s.split(/[\s,]+/).map(x => x.trim()).filter(Boolean);
            }
            // if looks like concatenated UCI moves (letters/numbers only and length multiple of 4)
            const onlyAlnum = /^[a-h1-8]+$/i.test(s.replace(/[^a-z0-9]/gi, ''));
            if (onlyAlnum && (s.length % 4 === 0)) {
                const arr = [];
                for (let i = 0; i < s.length; i += 4) arr.push(s.slice(i, i+4));
                return arr;
            }
            // fallback: return as single item
            return [s];
        };

        // --- Submit Solution & Ranking (improved error handling & logging) ---
        const submitSolution = async () => {
            if (!currentPuzzle) return;
            clearInterval(timerInterval);
            canMove = false;

            try {
                // 1) Try reading solution from the loaded puzzle document
                let correctRaw = currentPuzzle.solution || currentPuzzle.solution_moves || currentPuzzle.solutions || currentPuzzle.solution_str || currentPuzzle.solutionMoves;

                // 2) If not present, attempt to fetch a document in solutions collection with same id
                if (!correctRaw) {
                    try {
                        const solDoc = await db.collection('solutions').doc(currentPuzzle.id).get();
                        if (solDoc.exists) {
                            const data = solDoc.data();
                            correctRaw = data.solutions || data.solution_moves || data.solution || data.solution_str || data.solutionMoves;
                        }
                    } catch (innerErr) {
                        // log but continue to other fallbacks
                        console.warn("solutions.doc fetch failed:", innerErr);
                    }
                }

                // 3) If still not present, try querying solutions where puzzleId/puzzle_id matches
                if (!correctRaw) {
                    try {
                        const q1 = await db.collection('solutions').where('puzzleId', '==', currentPuzzle.id).limit(1).get();
                        if (!q1.empty) {
                            const d = q1.docs[0].data();
                            correctRaw = d.solutions || d.solution_moves || d.solution || d.solution_str || d.solutionMoves;
                        } else {
                            const q2 = await db.collection('solutions').where('puzzle_id', '==', currentPuzzle.id).limit(1).get();
                            if (!q2.empty) {
                                const d = q2.docs[0].data();
                                correctRaw = d.solutions || d.solution_moves || d.solution || d.solution_str || d.solutionMoves;
                            }
                        }
                    } catch (innerErr2) {
                        console.warn("solutions.query fetch failed:", innerErr2);
                    }
                }

                if (!correctRaw) {
                    console.warn("No solution field found for puzzle:", currentPuzzle.id, currentPuzzle);
                    alert("Solution for this puzzle could not be found!");
                    resetPuzzle();
                    return;
                }

                // Normalize to array of UCI-like tokens
                const correctMoves = normalizeSolution(correctRaw).map(m => m.toLowerCase());
                const userMoves = moveHistory.map(m => (''+m).toLowerCase());

                // If puzzle solution is a single move (mate in 1), allow first-move-only check
                let isCorrect = false;
                if (correctMoves.length === 1) {
                    // compare only the first user move if user provided at least one move
                    isCorrect = userMoves.length >= 1 && userMoves[0] === correctMoves[0];
                } else {
                    // require exact sequence match
                    isCorrect = (userMoves.length === correctMoves.length) &&
                        userMoves.every((m, i) => m === (correctMoves[i] || ''));
                }

                // time taken in seconds:
                const elapsed = startTime ? Math.floor((Date.now() - startTime) / 1000) : 0;

                // record the submission
                try {
                    await db.collection('submissions').add({
                        puzzleId: currentPuzzle.id,
                        userId: currentUser ? currentUser.uid : null,
                        moves: userMoves,
                        timeTaken: elapsed,
                        correct: isCorrect,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (recErr) {
                    console.warn("Failed writing submission record:", recErr);
                }

                if (isCorrect) {
                    // increment user's solved count
                    if (currentUser) {
                        try {
                            await db.collection('users').doc(currentUser.uid).set({
                                solvedCount: firebase.firestore.FieldValue.increment(1)
                            }, { merge: true });
                        } catch (incErr) {
                            console.warn("Failed incrementing solvedCount:", incErr);
                        }

                        // compute ranking (position among users by solvedCount desc)
                        try {
                            const usersSnap = await db.collection('users').orderBy('solvedCount', 'desc').get();
                            let rank = -1;
                            usersSnap.forEach((uDoc, idx) => {
                                if (uDoc.id === currentUser.uid) rank = idx + 1;
                            });
                            alert(`Correct! Puzzle Solved!\nTime: ${elapsed}s\nYour rank: ${rank > 0 ? rank : 'â€”'}`);
                        } catch (rankErr) {
                            console.warn("Failed computing rank:", rankErr);
                            alert(`Correct! Puzzle Solved!\nTime: ${elapsed}s`);
                        }
                    } else {
                        alert("Correct! Puzzle Solved!");
                    }
                } else {
                    alert("That's not the right solution. Try again!");
                }

            } catch (error) {
                // Improved error handling: log details and show message
                console.error("Error fetching/verifying solution:", error);
                // If it's a Firestore permission error, show explicit hint
                if (error && error.code) {
                    alert(`Could not verify solution at this time. (Firestore error: ${error.code})`);
                } else if (error && error.message) {
                    alert(`Could not verify solution at this time: ${error.message}`);
                } else {
                    alert("Could not verify solution at this time.");
                }
            }

            resetPuzzle();
        };

        // --- Admin & Puzzle Creation ---
        const checkAdminPassword = () => {
            if (document.getElementById('admin-password').value === 'chessclub@rkv') {
                document.getElementById('admin-check').classList.add('hidden');
                document.getElementById('create-form').classList.remove('hidden');
            } else {
                alert('Incorrect admin password!');
            }
        };

        // Save puzzle: store solution both in puzzle document (string) and in solutions collection (array) to keep compatibility
        const savePuzzle = async () => {
            const title = document.getElementById('new-title').value;
            const description = document.getElementById('new-description').value;
            const fen = document.getElementById('new-fen').value;
            const solutionInput = document.getElementById('new-solution').value;

            if (!title || !fen || !solutionInput) {
                alert('Title, FEN String, and Solution are required.');
                return;
            }

            const docId = title.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            if (!docId) { alert('Invalid title for use as an ID.'); return; }

            const solutionArray = normalizeSolution(solutionInput);
            // prefer storing solution as a comma-separated UCI string in puzzle doc for compatibility with backend
            const solutionString = solutionArray.join(',');

            try {
                // puzzle doc: includes solution string and createdAt timestamp
                await db.collection('puzzles').doc(docId).set({
                    title,
                    description,
                    fen,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    created_by: (currentUser && currentUser.email) ? currentUser.email : 'web',
                    source: 'manual',
                    solution: solutionString
                });

                // also write to solutions collection as an array (older UI versions used this)
                await db.collection('solutions').doc(docId).set({
                    solutions: solutionArray,
                    puzzleId: docId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Puzzle saved successfully!');
                document.getElementById('puzzle-form').reset();
                showTab('dashboard');
                loadPuzzles();
            } catch (err) {
                console.error("Error saving puzzle:", err);
                alert('An error occurred while saving. See console for details.');
            }
        };

        // Initial render board
        renderBoard(createBoardFromFEN(null));
    </script>
</body>
</html>
