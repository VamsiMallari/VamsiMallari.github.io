<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Puzzle Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 60px);
            grid-template-rows: repeat(8, 60px);
            border: 4px solid #374151;
        }
        .chess-square {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .chess-square:hover {
            transform: scale(1.05);
        }
        .light-square {
            background-color: #f0d9b5;
        }
        .dark-square {
            background-color: #b58863;
        }
        .selected {
            box-shadow: inset 0 0 0 3px #22c55e;
        }
        .possible-move::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #22c55e;
            border-radius: 50%;
            opacity: 0.8;
            z-index: 10;
        }
        .possible-capture::after {
            content: '';
            position: absolute;
            width: 50px;
            height: 50px;
            border: 4px solid #22c55e;
            border-radius: 50%;
            opacity: 0.8;
            z-index: 10;
        }
        .last-move {
            background-color: #fbbf24 !important;
        }
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen">
    
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">♔ Chess Puzzle Master ♛</h2>
            
            <div id="login-form">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Login</h3>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">Login</button>
                </form>
                <p class="text-center mt-4 text-gray-600">Don't have an account? <button onclick="showRegister()" class="text-blue-600 hover:underline">Register</button></p>
            </div>

            <div id="register-form" class="hidden">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Register</h3>
                <form onsubmit="handleRegister(event)" class="space-y-4">
                    <input type="text" id="register-name" placeholder="Full Name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <input type="email" id="register-email" placeholder="Email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="register-password" placeholder="Password (min 6 characters)" required minlength="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors">Register</button>
                </form>
                <p class="text-center mt-4 text-gray-600">Already have an account? <button onclick="showLogin()" class="text-blue-600 hover:underline">Login</button></p>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6 flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold text-gray-800">♔ Chess Puzzle Master ♛</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-700">Welcome, <span id="user-name" class="font-medium"></span></span>
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Logout</button>
                </div>
            </div>
        </header>

        <nav class="max-w-7xl mx-auto px-4 mt-6">
            <div class="flex space-x-1 bg-white rounded-lg p-1 shadow-md">
                <button onclick="showTab('solve')" id="solve-tab" class="tab-active flex-1 py-3 px-6 rounded-md font-medium">🧩 Solve Puzzles</button>
                <button onclick="showTab('dashboard')" id="dashboard-tab" class="flex-1 py-3 px-6 rounded-md font-medium hover:bg-gray-100">📊 Dashboard</button>
                <button onclick="showTab('create')" id="create-tab" class="flex-1 py-3 px-6 rounded-md font-medium hover:bg-gray-100">➕ Create Puzzle</button>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <div id="solve-content" class="tab-content">
                <div class="flex flex-col items-center space-y-8">
                    <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800" id="puzzle-title">Select a puzzle to start</h2>
                            <div class="flex space-x-2">
                                <button onclick="resetPuzzle()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">🔄 Reset</button>
                                <button onclick="startSolving()" id="solve-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">🎯 Solve</button>
                                <button onclick="submitSolution()" id="submit-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 hidden">✅ Submit</button>
                            </div>
                        </div>
                        <p class="text-gray-700" id="puzzle-description">Select a puzzle from the dashboard to begin.</p>
                    </div>

                    <div class="bg-white rounded-xl shadow-2xl p-8 inline-block">
                        <div class="chess-board mx-auto" id="chess-board"></div>
                    </div>

                    <div class="w-full max-w-4xl grid md:grid-cols-2 gap-6">
                         <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Game Info</h3>
                             <p><strong>Status:</strong> <span id="game-status">Ready</span></p>
                             <p><strong>Move:</strong> <span id="move-counter">-</span></p>
                             <p><strong>Time:</strong> <span id="timer" class="font-bold text-lg">00:00</span></p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Move History</h3>
                            <div class="bg-gray-50 rounded-lg p-4 min-h-[100px]" id="move-history"><p class="italic">No moves yet.</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="dashboard-content" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Puzzle Collection</h2>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="puzzle-grid">
                        <p class="text-center py-8 text-gray-500">Loading puzzles...</p>
                    </div>
                </div>
            </div>

            <div id="create-content" class="tab-content hidden">
                 <div id="admin-check" class="bg-white rounded-xl shadow-lg p-6 mb-8 max-w-lg mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Access Required</h2>
                    <div class="flex space-x-4">
                        <input type="password" id="admin-password" placeholder="Enter admin password" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <button onclick="checkAdminPassword()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Verify</button>
                    </div>
                </div>
                <div id="create-form" class="hidden bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Create New Puzzle</h2>
                    <form id="puzzle-form" class="space-y-4">
                        <input type="text" id="new-title" class="w-full p-2 border rounded" placeholder="Puzzle Title (e.g., Anatoly Karpov vs Kasparov)">
                        <textarea id="new-description" rows="2" class="w-full p-2 border rounded" placeholder="Description"></textarea>
                        <input type="text" id="new-fen" class="w-full p-2 border rounded" placeholder="Paste FEN String here">
                        <input type="text" id="new-solution" class="w-full p-2 border rounded" placeholder="Solution Moves (e.g., Qh5+ Kg8 Qh8#)">
                        <button type="button" onclick="savePuzzle()" class="w-full py-3 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600">Save Puzzle</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCuSurKpIMGQv8-yu4txJE_8_KZk5lSJ3w",
            authDomain: "chess-puzzels-rkv.firebaseapp.com",
            projectId: "chess-puzzels-rkv",
            storageBucket: "chess-puzzels-rkv.firebasestorage.app",
            messagingSenderId: "130806565295",
            appId: "1:130806565295:web:6f09088b2072e815ecc75a",
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const pieces = {
            'K': '♔', 'Q': '♕', 'R': '♖', 'B': '♗', 'N': '♘', 'P': '♙',
            'k': '♚', 'q': '♛', 'r': '✜', 'b': '♝', 'n': '♞', 'p': '♟'
        };

        let currentBoard = [];
        let selectedSquare = null;
        let gameState = 'ready';
        let currentPuzzle = null;
        let currentUser = null;
        let moveHistory = [];
        let playerTurn = 'w';
        let canMove = false;
        let timerInterval = null;
        let startTime = null;

        // --- Authentication ---
        const showLogin = () => {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
        };
        const showRegister = () => {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        };
        const handleLogin = async (e) => {
            e.preventDefault();
            try {
                await auth.signInWithEmailAndPassword(e.target['login-email'].value, e.target['login-password'].value);
            } catch (err) { alert(err.message); }
        };
        const handleRegister = async (e) => {
            e.preventDefault();
            const name = e.target['register-name'].value;
            const email = e.target['register-email'].value;
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, e.target['register-password'].value);
                await db.collection('users').doc(cred.user.uid).set({ name, email });
            } catch (err) { alert(err.message); }
        };
        const logout = () => auth.signOut();

        // --- Tab Management ---
        const showTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('[id$="-tab"]').forEach(t => t.classList.remove('tab-active'));
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.getElementById(`${tabName}-tab`).classList.add('tab-active');
        };
        
        // --- Board Logic ---
        const createBoard = (containerId, fen) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const board = Array(8).fill(null).map(() => Array(8).fill(''));

            if (fen) {
                const [position] = fen.split(' ');
                const ranks = position.split('/');
                for (let rank = 0; rank < 8; rank++) {
                    let file = 0;
                    for (const char of ranks[rank]) {
                        if (isNaN(char)) {
                            board[rank][file] = char;
                            file++;
                        } else {
                            file += parseInt(char);
                        }
                    }
                }
            }

            for (let rank = 0; rank < 8; rank++) {
                for (let file = 0; file < 8; file++) {
                    const square = document.createElement('div');
                    square.className = `chess-square ${(rank + file) % 2 === 0 ? 'light-square' : 'dark-square'}`;
                    square.dataset.rank = rank;
                    square.dataset.file = file;
                    if (board[rank][file]) square.textContent = pieces[board[rank][file]];
                    if (containerId === 'chess-board') {
                        square.addEventListener('click', () => handleSquareClick(rank, file));
                    }
                    container.appendChild(square);
                }
            }
            currentBoard = board;
        };
        
        // --- Puzzle Loading & Display ---
        const loadPuzzles = async () => {
            const snapshot = await db.collection('puzzles').orderBy('createdAt', 'desc').get();
            const puzzles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const grid = document.getElementById('puzzle-grid');
            grid.innerHTML = '';
            puzzles.forEach(puzzle => {
                const card = document.createElement('div');
                card.className = "p-4 border rounded-lg cursor-pointer hover:bg-gray-100";
                card.innerHTML = `
                    <h3 class="font-bold">${puzzle.title}</h3>
                    <p class="text-sm text-gray-600">${puzzle.description}</p>`;
                card.onclick = () => {
                    showTab('solve');
                    loadPuzzle(puzzle);
                };
                grid.appendChild(card);
            });
        };
        
        const loadPuzzle = (puzzle) => {
            // *** CRITICAL CHANGE HERE ***
            // The code now looks for the 'fen' field in your puzzle data.
            // It falls back to a default starting position if 'fen' is missing.
            const fen = puzzle.fen; 
            if (!fen) {
                alert(`Error: Puzzle "${puzzle.title}" is missing the 'fen' field in the database. The board cannot be loaded.`);
                createBoard('chess-board', '8/8/8/8/8/8/8/8 w - - 0 1'); // Load empty board
                return;
            }

            currentPuzzle = puzzle;
            playerTurn = fen.split(' ')[1] || 'w';

            createBoard('chess-board', fen);
            
            document.getElementById('puzzle-title').textContent = puzzle.title;
            document.getElementById('puzzle-description').textContent = puzzle.description;
            resetGameState();
        };

        const resetGameState = () => {
            gameState = 'ready';
            moveHistory = [];
            canMove = false;
            selectedSquare = null;
            clearInterval(timerInterval);
            startTime = null;
            document.getElementById('timer').textContent = '00:00';
            document.getElementById('game-status').textContent = `Ready. ${playerTurn === 'w' ? 'White' : 'Black'} to move.`;
            document.getElementById('move-counter').textContent = '1';
            document.getElementById('move-history').innerHTML = `<p class="italic">Click Solve to begin.</p>`;
            document.getElementById('solve-btn').classList.remove('hidden');
            document.getElementById('submit-btn').classList.add('hidden');
        };
        
        const resetPuzzle = () => {
            if (currentPuzzle) loadPuzzle(currentPuzzle);
        };
        
        // --- Game Interaction ---
        const startSolving = () => {
            if (!currentPuzzle) return;
            canMove = true;
            gameState = 'playing';
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
                const secs = String(elapsed % 60).padStart(2, '0');
                document.getElementById('timer').textContent = `${mins}:${secs}`;
            }, 1000);
            document.getElementById('game-status').textContent = `${playerTurn === 'w' ? 'White' : 'Black'}'s turn`;
            document.getElementById('solve-btn').classList.add('hidden');
            document.getElementById('submit-btn').classList.remove('hidden');
            document.getElementById('move-history').innerHTML = `<p class="italic">Make your move.</p>`;
        };

        const handleSquareClick = (rank, file) => {
            if (!canMove) return;
            
            const piece = currentBoard[rank][file];
            const isMyPiece = (playerTurn === 'w' && piece.toUpperCase() === piece) || (playerTurn === 'b' && piece.toLowerCase() === piece);

            if (selectedSquare) {
                // Simplified move logic, no validation for this example
                const from = selectedSquare;
                currentBoard[rank][file] = currentBoard[from.rank][from.file];
                currentBoard[from.rank][from.file] = '';
                
                // Update UI
                const fromSquareEl = document.querySelector(`[data-rank="${from.rank}"][data-file="${from.file}"]`);
                const toSquareEl = document.querySelector(`[data-rank="${rank}"][data-file="${file}"]`);
                toSquareEl.textContent = fromSquareEl.textContent;
                fromSquareEl.textContent = '';
                
                // Log move (simplified)
                const move = `${fromSquareEl.textContent}${String.fromCharCode(97+file)}${8-rank}`;
                moveHistory.push(move);
                updateMoveHistory();

                // Switch turn
                playerTurn = playerTurn === 'w' ? 'b' : 'w';
                document.getElementById('game-status').textContent = `${playerTurn === 'w' ? 'White' : 'Black'}'s turn`;
                if (playerTurn === 'w') {
                    const moveNum = parseInt(document.getElementById('move-counter').textContent) + 1;
                    document.getElementById('move-counter').textContent = moveNum;
                }
                
                selectedSquare = null;
                document.querySelectorAll('.selected').forEach(s => s.classList.remove('selected'));

            } else if (piece && isMyPiece) {
                selectedSquare = { rank, file };
                document.querySelector(`[data-rank="${rank}"][data-file="${file}"]`).classList.add('selected');
            }
        };

        const updateMoveHistory = () => {
            const historyDiv = document.getElementById('move-history');
            let html = '';
            for (let i = 0; i < moveHistory.length; i += 2) {
                html += `<span class="inline-block mr-4">${(i / 2) + 1}. ${moveHistory[i]} ${moveHistory[i + 1] || ''}</span>`;
            }
            historyDiv.innerHTML = html || `<p class="italic">No moves yet.</p>`;
        };
        
        const submitSolution = async () => {
            if (!currentPuzzle) return;
            
            clearInterval(timerInterval);
            canMove = false;
            
            const solutionDoc = await db.collection('solutions').doc(currentPuzzle.id).get();
            if (!solutionDoc.exists) {
                alert("Solution for this puzzle not found!");
                resetPuzzle();
                return;
            }

            const correctSolution = solutionDoc.data().solutions;
            // Basic check: compare number of moves. A real check would be more complex.
            if (moveHistory.length >= correctSolution.length) {
                alert("Correct! Puzzle solved.");
            } else {
                alert("Incorrect solution. Try again!");
            }
            resetPuzzle();
        };

        // --- Admin / Create Puzzle ---
        const checkAdminPassword = () => {
             if (document.getElementById('admin-password').value === 'chessclub@rkv') {
                document.getElementById('admin-check').classList.add('hidden');
                document.getElementById('create-form').classList.remove('hidden');
            } else {
                alert('Incorrect admin password!');
            }
        };
        
        const savePuzzle = async () => {
            const title = document.getElementById('new-title').value;
            const description = document.getElementById('new-description').value;
            const fen = document.getElementById('new-fen').value;
            const solutionInput = document.getElementById('new-solution').value;

            if (!title || !fen || !solutionInput) {
                alert('Title, FEN, and Solution are required.');
                return;
            }

            // Create a URL-friendly slug from the title to use as the Document ID
            const docId = title.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');

            try {
                // Save puzzle using the slug as ID
                await db.collection('puzzles').doc(docId).set({
                    title,
                    description,
                    fen,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Save solution using the same slug as ID
                const solutionMoves = solutionInput.trim().split(/\s+/);
                await db.collection('solutions').doc(docId).set({
                    solutions: solutionMoves,
                    puzzleId: docId // Reference back to the puzzle
                });

                alert('Puzzle saved successfully!');
                document.getElementById('puzzle-form').reset();
                showTab('dashboard');
                loadPuzzles();

            } catch (err) {
                console.error("Error saving puzzle: ", err);
                alert('Error saving puzzle.');
            }
        };

        // --- App Initialization ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    document.getElementById('user-name').textContent = userDoc.data().name;
                }
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('auth-modal').classList.add('hidden');
                loadPuzzles();
            } else {
                currentUser = null;
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('auth-modal').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
