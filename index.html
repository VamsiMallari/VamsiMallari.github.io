<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chess Puzzles Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase v10 modules -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, setDoc, getDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyCuSurKpIMGQv8-yu4txJE_8_KZk5lSJ3w",
      authDomain: "chess-puzzels-rkv.firebaseapp.com",
      projectId: "chess-puzzels-rkv",
      storageBucket: "chess-puzzels-rkv.firebasestorage.app",
      messagingSenderId: "130806565295",
      appId: "1:130806565295:web:6f09088b2072e815ecc75a",
      measurementId: "G-87H1RF04D7"
    };

    // --- Firebase init ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);

    // Expose minimally (used by inline handlers below)
    window._fb = { db, collection, addDoc, setDoc, getDoc, doc, onSnapshot, query, orderBy, auth,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut };

    // ------------------ UI helpers ------------------
    const $ = (id) => document.getElementById(id);

    function toast(msg) {
      console.log(msg);
    }

    // ------------------ Chess helpers ------------------
    const PIECES = {
      'P': '♙', 'N': '♘', 'B': '♗', 'R': '♖', 'Q': '♕', 'K': '♔',
      'p': '♟', 'n': '♞', 'b': '♝', 'r': '♜', 'q': '♛', 'k': '♚'
    };

    function fenToBoard(fen) {
      // returns 8x8 array of single-char piece codes or '' (empty)
      const board = [];
      const rows = fen.split(' ')[0].split('/');
      for (let r = 0; r < 8; r++) {
        const row = [];
        for (const ch of rows[r]) {
          if (/\d/.test(ch)) {
            for (let i = 0; i < Number(ch); i++) row.push('');
          } else {
            row.push(ch);
          }
        }
        board.push(row);
      }
      return board;
    }

    // very tiny SAN highlighter (for showing solution only)
    function renderSANList(moves) {
      return moves.map((m, i) => `<span class="px-1">${i+1}.${m}</span>`).join('');
    }

    // Render a board (8x8 array from fenToBoard) into a container
    function renderBoard(board, containerId, onSquareClick) {
      const el = $(containerId);
      el.innerHTML = '';

      const top = document.createElement('div');
      top.className = 'flex ml-5 mb-1';
      'abcdefgh'.split('').forEach(f => {
        const d = document.createElement('div');
        d.className = 'file-label';
        d.style.width = '56px'; d.style.height = '18px';
        d.textContent = f;
        top.appendChild(d);
      });
      el.appendChild(top);

      const wrap = document.createElement('div');
      wrap.className = 'flex';

      const ranks = document.createElement('div');
      ranks.className = 'flex flex-col mr-1';
      for (let r = 8; r >= 1; r--) {
        const d = document.createElement('div');
        d.className = 'rank-label';
        d.style.width = '18px'; d.style.height = '56px';
        d.textContent = r;
        ranks.appendChild(d);
      }
      wrap.appendChild(ranks);

      const grid = document.createElement('div');
      grid.className = 'grid';
      grid.style.gridTemplateColumns = 'repeat(8, 56px)';
      grid.style.gridTemplateRows = 'repeat(8, 56px)';
      grid.style.border = '2px solid #333';

      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const sq = document.createElement('div');
          const light = (r + c) % 2 === 0;
          sq.className = `flex items-center justify-center text-2xl cursor-pointer ${light ? 'bg-[#f0d9b5]' : 'bg-[#b58863]'} border border-black/20`;
          sq.style.userSelect = 'none';
          const p = board[r][c];
          sq.textContent = p ? PIECES[p] || '' : '';
          if (onSquareClick) sq.onclick = () => onSquareClick(r, c);
          grid.appendChild(sq);
        }
      }
      wrap.appendChild(grid);
      el.appendChild(wrap);
    }

    // ------------------ App state ------------------
    let puzzles = [];        // [{id, title, fen, sideToMove, solutionSAN, description, createdAt,...}]
    let results = {};        // { [puzzleId]: [ {playerName, moves:[], isCorrect, timeSpent, submittedAt} ] }

    // ------------------ Auth UI ------------------
    function showAuth(isLoggedIn, user) {
      if (isLoggedIn) {
        $('navUser').textContent = user.email;
        $('btnLogout').classList.remove('hidden');
        $('btnLogin').classList.add('hidden');
        $('loginModal').classList.add('hidden');
      } else {
        $('navUser').textContent = 'Guest';
        $('btnLogout').classList.add('hidden');
        $('btnLogin').classList.remove('hidden');
      }
    }

    $('btnLogin').onclick = () => $('loginModal').classList.remove('hidden');
    $('btnLogout').onclick = async () => { await window._fb.signOut(window._fb.auth); };

    $('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('email').value.trim();
      const password = $('password').value;
      $('loginBtn').disabled = true;
      try {
        await window._fb.signInWithEmailAndPassword(window._fb.auth, email, password);
      } catch (err) {
        if (err.code === 'auth/user-not-found') {
          await window._fb.createUserWithEmailAndPassword(window._fb.auth, email, password);
        } else {
          alert(err.message);
        }
      } finally {
        $('loginBtn').disabled = false;
      }
    });

    $('closeLogin').onclick = () => $('loginModal').classList.add('hidden');

    onAuthStateChanged(auth, (user) => {
      showAuth(!!user, user || {});
      // gate main content
      $('app').classList.toggle('hidden', !user);
      if (!user) $('loginModal').classList.remove('hidden');
    });

    // ------------------ Firestore listeners ------------------
    function startListeners() {
      // Puzzles
      const qP = window._fb.query(window._fb.collection(window._fb.db, 'puzzles'), window._fb.orderBy('createdAt', 'desc'));
      window._fb.onSnapshot(qP, (snap) => {
        const arr = [];
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          const createdAt = d.createdAt?.toDate ? d.createdAt.toDate() : new Date(d.createdAt || Date.now());

          // Prefer new Python shape (fen/solutionSAN/sideToMove)
          const fen = d.fen || '';
          const board = fen ? fenToBoard(fen) : (Array.isArray(d.board) ? d.board : []);
          const sideToMove = d.sideToMove || (d.firstMove === 'white' ? 'w' : 'b');
          const solutionSAN = Array.isArray(d.solutionSAN) ? d.solutionSAN : (Array.isArray(d.solution) ? d.solution : []);

          arr.push({
            id: docSnap.id,
            title: d.title || 'Untitled Puzzle',
            description: d.description || '',
            fen,
            board,
            sideToMove,
            solutionSAN,
            hasSolutions: solutionSAN.length > 0,
            createdAt
          });
        });
        puzzles = arr;
        renderPuzzles();
        toast(`Loaded ${puzzles.length} puzzles`);
      });

      // Results
      const rCol = window._fb.collection(window._fb.db, 'results');
      window._fb.onSnapshot(rCol, (snap) => {
        const map = {};
        snap.forEach((docSnap) => { map[docSnap.id] = docSnap.data().submissions || []; });
        results = map;
        renderResults();
      });
    }

    // ------------------ Rendering ------------------
    function renderPuzzles() {
      const list = $('puzzlesList');
      list.innerHTML = '';
      puzzles.forEach((p) => {
        const li = document.createElement('div');
        li.className = 'p-4 rounded-lg border bg-white shadow-sm mb-3';
        li.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <div class="text-lg font-semibold">${p.title}</div>
              <div class="text-sm text-gray-500">${p.description || ''}</div>
              <div class="text-xs text-gray-400 mt-1">Created ${p.createdAt.toLocaleString()}</div>
            </div>
            <button class="px-4 py-2 bg-blue-600 text-white rounded-md" data-id="${p.id}">Solve</button>
          </div>
          <div class="mt-3" id="board-${p.id}"></div>
          <div class="mt-2 text-sm">${p.hasSolutions ? '<span class="text-green-700">Has solution</span>' : '<span class="text-gray-500">Open puzzle</span>'}</div>
        `;
        list.appendChild(li);

        // draw preview board
        const board = p.board && p.board.length ? p.board : (p.fen ? fenToBoard(p.fen) : []);
        renderBoard(board, `board-${p.id}`);

        li.querySelector('button').onclick = () => openSolve(p.id);
      });
    }

    function renderResults() {
      const list = $('resultsList');
      list.innerHTML = '';
      puzzles.forEach((p) => {
        const arr = (results[p.id] || []).slice();
        // sort: correct first by time, then incorrect
        arr.sort((a, b) => {
          if (a.isCorrect && !b.isCorrect) return -1;
          if (!a.isCorrect && b.isCorrect) return 1;
          if (a.isCorrect && b.isCorrect) return (a.timeSpent || 0) - (b.timeSpent || 0);
          return 0;
        });

        const card = document.createElement('div');
        card.className = 'p-4 rounded-lg border bg-white shadow-sm mb-3';
        const correct = arr.filter(x => x.isCorrect !== false);
        const wrong = arr.filter(x => x.isCorrect === false);

        const correctHtml = correct.map((r, i) => `
          <div class="border-l-4 ${i===0?'border-yellow-400 bg-yellow-50':i===1?'border-gray-400 bg-gray-50':i===2?'border-orange-400 bg-orange-50':'border-gray-300'} pl-3 py-2 mb-2">
            <div class="flex justify-between">
              <div class="font-medium">${r.playerName || 'Anonymous'} <span class="text-green-600 text-sm">✓</span></div>
              <div class="text-xs text-gray-500">${new Date(r.submittedAt).toLocaleString()}</div>
            </div>
            <div class="text-xs text-gray-600">Time: ${formatTime(r.timeSpent||0)} • Moves: ${r.moveCount||0} • ${Array.isArray(r.moves)?r.moves.join(' '):''}</div>
          </div>`).join('');

        const wrongHtml = wrong.length ? `
          <div class="mt-3">
            <div class="font-medium mb-1">Other submissions</div>
            ${wrong.map(r => `
              <div class="border-l-4 border-red-400 bg-red-50 pl-3 py-2 mb-2">
                <div class="flex justify-between">
                  <div class="font-medium">${r.playerName || 'Anonymous'} <span class="text-red-600 text-sm">✗</span></div>
                  <div class="text-xs text-gray-500">${new Date(r.submittedAt).toLocaleString()}</div>
                </div>
                <div class="text-xs text-gray-600">Time: ${formatTime(r.timeSpent||0)} • Moves: ${r.moveCount||0} • ${Array.isArray(r.moves)?r.moves.join(' '):''}</div>
              </div>`).join('')}
          </div>` : '';

        card.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="text-lg font-semibold">${p.title}</div>
            <div class="text-sm text-gray-500">${arr.length} submission${arr.length!==1?'s':''}</div>
          </div>
          ${correct.length?`<div class="font-medium mb-1">Correct (ranked)</div>${correctHtml}`:'<div class="text-gray-500">No submissions yet.</div>'}
          ${wrongHtml}
        `;
        list.appendChild(card);
      });
    }

    // ------------------ Solve modal ------------------
    let currentSolve = null;
    let timerId = null; let elapsed = 0;

    function formatTime(s) {
      const m = Math.floor(s/60).toString().padStart(2,'0');
      const sec = (s%60).toString().padStart(2,'0');
      return `${m}:${sec}`;
    }

    function tick() {
      elapsed += 1;
      $('puzzleTimer').textContent = formatTime(elapsed);
    }

    function openSolve(id) {
      const p = puzzles.find(x => x.id === id);
      if (!p) return;
      currentSolve = p;
      elapsed = 0; clearInterval(timerId); timerId = setInterval(tick, 1000);

      $('solveTitle').textContent = p.title;
      $('solveDesc').textContent = p.description || '';
      const board = p.board && p.board.length ? p.board : (p.fen ? fenToBoard(p.fen) : []);
      renderBoard(board, 'solveBoard');
      $('solutionPath').innerHTML = p.solutionSAN?.length ? renderSANList(p.solutionSAN) : '<span class="text-gray-500">No official solution</span>';
      $('solveModal').classList.remove('hidden');
    }

    $('closeSolve').onclick = () => { $('solveModal').classList.add('hidden'); clearInterval(timerId); };

    $('submitSolution').onclick = async () => {
      const name = ($('playerName').value || 'Anonymous').trim();
      const data = {
        playerName: name,
        moves: [],            // (optional: capture your UI move list here)
        moveCount: 0,
        isCorrect: false,     // you can set true if you validate against solutionSAN client-side
        timeSpent: elapsed,
        submittedAt: new Date().toISOString()
      };

      // Firestore write (merge/update result doc)
      const ref = window._fb.doc(window._fb.db, 'results', currentSolve.id);
      const snap = await window._fb.getDoc(ref);
      const subs = snap.exists() ? (snap.data().submissions || []) : [];
      subs.push(data);
      // sort so the server data stays consistent
      subs.sort((a,b)=>{
        if (a.isCorrect && !b.isCorrect) return -1;
        if (!a.isCorrect && b.isCorrect) return 1;
        if (a.isCorrect && b.isCorrect) return (a.timeSpent||0)-(b.timeSpent||0);
        return 0;
      });
      await window._fb.setDoc(ref, { puzzleId: currentSolve.id, submissions: subs, lastUpdated: new Date() }, { merge: true });
      $('solveModal').classList.add('hidden');
      clearInterval(timerId);
    };

    // ------------------ Startup ------------------
    // Fix a previous error: bad Set merge syntax that caused console crashes in older file
    // (replaced with a correct version; see earlier broken line in your file). :contentReference[oaicite:2]{index=2}

    // Start listeners once the DOM is ready
    window.addEventListener('DOMContentLoaded', () => {
      startListeners();
    });
  </script>

  <style>
    .file-label{display:flex;align-items:center;justify-content:center;font-weight:600;color:#333}
    .rank-label{display:flex;align-items:center;justify-content:center;font-weight:600;color:#333}
  </style>
</head>
<body class="bg-slate-50">
  <!-- NAV -->
  <header class="bg-white border-b sticky top-0 z-10">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="text-xl font-bold">Chess Puzzles Hub</div>
      <div class="flex items-center gap-3">
        <span id="navUser" class="text-sm text-gray-600">Guest</span>
        <button id="btnLogin" class="px-3 py-1.5 bg-blue-600 text-white rounded-md">Log in</button>
        <button id="btnLogout" class="px-3 py-1.5 bg-gray-100 rounded-md hidden">Log out</button>
      </div>
    </div>
  </header>

  <!-- APP -->
  <main id="app" class="max-w-5xl mx-auto px-4 py-6 hidden">
    <div class="grid md:grid-cols-2 gap-6">
      <section>
        <h2 class="text-lg font-semibold mb-2">Puzzles</h2>
        <div id="puzzlesList"></div>
      </section>
      <section>
        <h2 class="text-lg font-semibold mb-2">Results</h2>
        <div id="resultsList"></div>
      </section>
    </div>
  </main>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="fixed inset-0 bg-black/40 items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-3">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Sign in / Register</h3>
        <button id="closeLogin" class="p-1.5 rounded hover:bg-gray-100">✕</button>
      </div>
      <form id="loginForm" class="space-y-3">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Email</label>
          <input id="email" type="email" required class="w-full border rounded-md px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Password</label>
          <input id="password" type="password" required class="w-full border rounded-md px-3 py-2">
        </div>
        <button id="loginBtn" class="w-full bg-blue-600 text-white rounded-md py-2">Continue</button>
        <p class="text-xs text-gray-500">If the email doesn’t exist, we’ll create the account automatically.</p>
      </form>
    </div>
  </div>

  <!-- SOLVE MODAL -->
  <div id="solveModal" class="fixed inset-0 bg-black/40 items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl mx-3">
      <div class="flex items-center justify-between mb-2">
        <div>
          <div id="solveTitle" class="text-lg font-semibold"></div>
          <div id="solveDesc" class="text-sm text-gray-600"></div>
        </div>
        <div class="text-sm text-gray-500">Time: <span id="puzzleTimer">00:00</span></div>
      </div>
      <div id="solveBoard" class="mb-4"></div>
      <div class="mb-2">
        <div class="font-medium">Official Solution</div>
        <div id="solutionPath" class="text-sm bg-gray-50 rounded p-2"></div>
      </div>
      <div class="flex items-center gap-2">
        <input id="playerName" placeholder="Your name (optional)" class="border rounded px-3 py-2 flex-1">
        <div class="flex-1"></div>
      </div>
      <div class="flex items-center justify-end gap-2 mt-4">
        <button id="closeSolve" class="px-3 py-2 rounded-md bg-gray-100">Cancel</button>
        <button id="submitSolution" class="px-4 py-2 rounded-md bg-green-600 text-white">Submit</button>
      </div>
    </div>
  </div>
</body>
</html>
