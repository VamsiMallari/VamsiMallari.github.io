<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chess Puzzle Master ‚Äî Futuristic</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Firebase (compat to keep prior code working) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <!-- Chess logic -->
  <script src="https://cdn.jsdelivr.net/npm/chess.js@0.13.4/chess.min.js"></script>
  <style>
    :root{
      --glass: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.18);
      --neon: 0 0 20px rgba(0, 255, 234, 0.45), 0 0 40px rgba(0, 140, 255, 0.25);
    }
    body{font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji';}
    .bg-grid{
      background: radial-gradient(1200px 600px at 10% -10%, rgba(0,255,234,0.15), transparent 60%),
                  radial-gradient(900px 600px at 110% 10%, rgba(0,140,255,0.2), transparent 55%),
                  linear-gradient(180deg, #0b1020, #0a0f1d 30%, #060a16 100%);
    }
    .glass{ backdrop-filter: blur(12px); background: var(--glass); border: 1px solid var(--stroke); }
    .neon-ring{ box-shadow: var(--neon); }
    .tab-active{ background: linear-gradient(135deg,#06b6d4,#3b82f6); color:white; }
    .chess-grid{ display:grid; grid-template-columns: repeat(8, minmax(40px, 64px)); grid-auto-rows: minmax(40px,64px); border-radius: 14px; overflow:hidden; border:2px solid rgba(255,255,255,0.12); }
    .sq{ position:relative; display:flex; align-items:center; justify-content:center; font-size: clamp(22px, 4.2vw, 36px); transition: transform .08s ease; cursor:pointer; }
    .sq:hover{ transform:scale(1.04); }
    .light{ background:#e9eef6; color:#1f2937; }
    .dark{ background:#1f2937; color:#e5e7eb; }
    .sq.sel{ outline:3px solid #22d3ee; outline-offset:-3px; }
    .sq.move::after{ content:""; position:absolute; width:22px; height:22px; border-radius:50%; background:rgba(34,211,238,.8); box-shadow:0 0 18px rgba(34,211,238,.7); }
    .toast{ animation: pop .2s ease-out; }
    @keyframes pop{ from{ transform: translateY(6px); opacity:.0 } to{ transform:none; opacity:1 } }
  </style>
</head>
<body class="bg-grid min-h-screen text-slate-100">
  <!-- Auth Modal -->
  <div id="authModal" class="fixed inset-0 hidden items-center justify-center bg-black/70 z-50">
    <div class="glass neon-ring rounded-2xl w-full max-w-md mx-3 p-6">
      <h1 class="text-2xl md:text-3xl font-bold text-center mb-6" style="font-family:Orbitron,Inter">‚ôüÔ∏è Chess Puzzle Master</h1>
      <div id="authTabs" class="flex gap-2 mb-5">
        <button id="tabLogin" class="flex-1 py-2 rounded-lg bg-white/5 hover:bg-white/10">Login</button>
        <button id="tabRegister" class="flex-1 py-2 rounded-lg bg-white/5 hover:bg-white/10">Register</button>
      </div>
      <!-- Login -->
      <form id="loginForm" class="space-y-4">
        <input id="loginEmail" type="email" required placeholder="Email" class="w-full glass rounded-lg px-4 py-3 text-white placeholder:slate-300">
        <div class="relative">
          <input id="loginPassword" type="password" required placeholder="Password" class="w-full glass rounded-lg px-4 py-3 pr-12 text-white placeholder:slate-300">
          <button type="button" id="toggleLoginPwd" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-300">üëÅÔ∏è</button>
        </div>
        <button class="w-full py-3 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-600 hover:opacity-95">Login</button>
        <div class="flex items-center justify-between text-sm">
          <button type="button" id="forgotBtn" class="text-cyan-300 hover:underline">Forgot Password?</button>
          <span class="opacity-70">New here? <button type="button" id="switchToRegister" class="text-pink-300 hover:underline">Register</button></span>
        </div>
      </form>
      <!-- Register -->
      <form id="registerForm" class="space-y-4 hidden">
        <input id="regName" required placeholder="Full name" class="w-full glass rounded-lg px-4 py-3 text-white placeholder:slate-300">
        <input id="regEmail" type="email" required placeholder="Email" class="w-full glass rounded-lg px-4 py-3 text-white placeholder:slate-300">
        <div class="relative">
          <input id="regPassword" type="password" required minlength="6" placeholder="Password (min 6 chars)" class="w-full glass rounded-lg px-4 py-3 pr-12 text-white placeholder:slate-300">
          <button type="button" id="toggleRegPwd" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-300">üëÅÔ∏è</button>
        </div>
        <button class="w-full py-3 rounded-lg bg-gradient-to-r from-emerald-500 to-teal-600 hover:opacity-95">Create account</button>
        <div class="text-sm text-right">Have an account? <button type="button" id="switchToLogin" class="text-cyan-300 hover:underline">Login</button></div>
      </form>
    </div>
  </div>

  <!-- App Shell -->
  <header class="px-4 md:px-8 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-xl glass neon-ring grid place-items-center">‚ôú</div>
      <div>
        <div class="text-lg md:text-xl font-semibold" style="font-family:Orbitron">Puzzle Master</div>
        <div class="text-xs opacity-70">Futuristic ¬∑ Dynamic ¬∑ Aesthetic</div>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <div id="userBadge" class="hidden md:flex items-center gap-2 glass rounded-xl px-3 py-1.5">
        <div class="h-2 w-2 rounded-full bg-emerald-400"></div>
        <span id="userEmail" class="text-sm"></span>
      </div>
      <button id="logoutBtn" class="glass rounded-xl px-4 py-2 hover:bg-white/10 hidden">Logout</button>
    </div>
  </header>

  <!-- Tabs -->
  <div class="px-4 md:px-8">
    <div class="glass rounded-2xl p-2 flex gap-2 overflow-x-auto">
      <button data-tab="dashboard" class="tab-btn tab-active rounded-xl px-4 py-2">Dashboard</button>
      <button data-tab="solve" class="tab-btn rounded-xl px-4 py-2">Solve</button>
      <button data-tab="create" class="tab-btn rounded-xl px-4 py-2">Create Puzzle</button>
      <button data-tab="leaderboard" class="tab-btn rounded-xl px-4 py-2">Leaderboard</button>
      <button data-tab="admin" class="tab-btn rounded-xl px-4 py-2">Admin</button>
    </div>
  </div>

  <!-- Views -->
  <main class="px-4 md:px-8 mt-6 space-y-6">

    <!-- Dashboard -->
    <section id="view-dashboard" class="glass rounded-2xl p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold" style="font-family:Orbitron">Puzzles</h2>
        <div class="flex items-center gap-3">
          <input id="searchInput" placeholder="Search title/desc" class="glass rounded-xl px-3 py-2 text-sm"/>
          <select id="filterHasSolutions" class="glass rounded-xl px-3 py-2 text-sm">
            <option value="any">All</option>
            <option value="true">With solutions</option>
            <option value="false">Without solutions</option>
          </select>
          <button id="refreshBtn" class="glass rounded-xl px-3 py-2">Refresh</button>
        </div>
      </div>
      <div id="puzzleGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <!-- Solve -->
    <section id="view-solve" class="glass rounded-2xl p-5 hidden">
      <div class="grid grid-cols-1 lg:grid-cols-[minmax(320px,520px)_1fr] gap-6">
        <div>
          <div id="board" class="chess-grid neon-ring"></div>
          <div class="mt-3 flex items-center justify-between">
            <div class="text-sm opacity-80">Turn: <span id="turnTag">-</span></div>
            <div class="flex gap-2">
              <button id="undoBtn" class="glass px-3 py-2 rounded-lg">Undo</button>
              <button id="resetBtn" class="glass px-3 py-2 rounded-lg">Reset</button>
            </div>
          </div>
        </div>
        <div class="space-y-4">
          <div class="glass rounded-xl p-4">
            <div class="text-sm opacity-80">Selected puzzle</div>
            <h3 id="solveTitle" class="text-lg font-semibold"></h3>
            <p id="solveDesc" class="opacity-80 mt-1"></p>
            <div class="mt-2 text-sm">First move: <span id="solveFirstMove" class="font-semibold"></span></div>
          </div>
          <div class="glass rounded-xl p-4">
            <div class="text-sm opacity-80 mb-2">Your moves</div>
            <div id="moveList" class="flex flex-wrap gap-2"></div>
          </div>
          <div class="glass rounded-xl p-4">
            <button id="checkBtn" class="w-full py-3 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-600">Check Solution</button>
            <div id="solveStatus" class="text-center mt-3 text-sm opacity-80"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Create -->
    <section id="view-create" class="glass rounded-2xl p-5 hidden">
      <h2 class="text-xl font-semibold mb-3" style="font-family:Orbitron">Create a Puzzle</h2>
      <form id="createForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input id="cTitle" required placeholder="Title" class="glass rounded-xl px-4 py-3" />
        <input id="cFirstMove" required placeholder="First move: w or b" class="glass rounded-xl px-4 py-3" />
        <textarea id="cDesc" placeholder="Description" class="md:col-span-2 glass rounded-xl px-4 py-3 h-24"></textarea>
        <textarea id="cFEN" placeholder="FEN (preferred)" class="md:col-span-2 glass rounded-xl px-4 py-3 h-20"></textarea>
        <textarea id="cBoardMap" placeholder='Board map JSON (optional) e.g. {"e2":"wp","e7":"bp"}' class="md:col-span-2 glass rounded-xl px-4 py-3 h-24"></textarea>
        <textarea id="cSolutions" placeholder="Solution moves (UCI or SAN, comma-separated)" class="md:col-span-2 glass rounded-xl px-4 py-3 h-24"></textarea>
        <label class="flex items-center gap-2"><input id="cHasSolutions" type="checkbox" class="accent-cyan-400"/> <span>Has solutions</span></label>
        <button class="md:col-span-2 py-3 rounded-lg bg-gradient-to-r from-emerald-500 to-teal-600">Save Puzzle</button>
      </form>
      <div id="createMsg" class="mt-3 text-sm"></div>
    </section>

    <!-- Leaderboard -->
    <section id="view-leaderboard" class="glass rounded-2xl p-5 hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold" style="font-family:Orbitron">Leaderboard</h2>
        <button id="refreshLb" class="glass rounded-xl px-3 py-2">Refresh</button>
      </div>
      <div id="lbTable" class="overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead class="text-slate-300">
            <tr>
              <th class="py-2 pr-4">#</th>
              <th class="py-2 pr-4">User</th>
              <th class="py-2 pr-4">Solved</th>
              <th class="py-2 pr-4">Avg Time (s)</th>
            </tr>
          </thead>
          <tbody id="lbBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Admin (manage solutions) -->
    <section id="view-admin" class="glass rounded-2xl p-5 hidden">
      <h2 class="text-xl font-semibold mb-4" style="font-family:Orbitron">Admin ‚Äî Solutions</h2>
      <form id="solutionForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input id="sPuzzleId" placeholder="Puzzle ID" class="glass rounded-xl px-4 py-3" />
        <input id="sMoves" placeholder="Moves (comma-separated SAN/ UCI)" class="glass rounded-xl px-4 py-3" />
        <button class="md:col-span-2 py-3 rounded-lg bg-gradient-to-r from-fuchsia-500 to-purple-700">Attach Solution</button>
      </form>
      <div class="text-sm mt-3 opacity-80">This saves to both <code>puzzles/{id}/solutions</code> and a top-level <code>solutions</code> collection for compatibility.</div>
    </section>

  </main>

  <!-- Toasts -->
  <div id="toastWrap" class="fixed bottom-4 left-1/2 -translate-x-1/2 space-y-2 z-[60]"></div>

  <script>
    // =========== Firebase CONFIG (replace with yours) ===========
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // =========== State ===========
    let currentUser = null;
    let chess = new Chess();
    let activePuzzle = null; // {id, data}
    let userMoves = []; // SAN moves the user played
    let startTs = null;

    // =========== UI Helpers ===========
    const q = (s, r=document) => r.querySelector(s);
    const qa = (s, r=document) => Array.from(r.querySelectorAll(s));
    function toast(msg){
      const el = document.createElement('div');
      el.className = 'toast glass neon-ring rounded-xl px-4 py-3';
      el.textContent = msg;
      q('#toastWrap').appendChild(el);
      setTimeout(()=>{ el.remove(); }, 3000);
    }
    function setTabs(active){
      qa('.tab-btn').forEach(b=>{
        if(b.dataset.tab===active){ b.classList.add('tab-active'); }
        else{ b.classList.remove('tab-active'); }
      });
      qa('[id^="view-"]').forEach(v=> v.classList.add('hidden'));
      q('#view-'+active).classList.remove('hidden');
    }

    // =========== Auth Modal ===========
    const authModal = q('#authModal');
    const loginForm = q('#loginForm');
    const registerForm = q('#registerForm');

    function showAuth(which='login'){
      authModal.classList.remove('hidden');
      if(which==='login'){ loginForm.classList.remove('hidden'); registerForm.classList.add('hidden');
        q('#tabLogin').classList.add('tab-active'); q('#tabRegister').classList.remove('tab-active');
      } else { registerForm.classList.remove('hidden'); loginForm.classList.add('hidden');
        q('#tabRegister').classList.add('tab-active'); q('#tabLogin').classList.remove('tab-active');
      }
    }
    function hideAuth(){ authModal.classList.add('hidden'); }

    // Tab switching inside auth
    q('#tabLogin').onclick = ()=>showAuth('login');
    q('#tabRegister').onclick = ()=>showAuth('register');
    q('#switchToRegister').onclick = ()=>showAuth('register');
    q('#switchToLogin').onclick = ()=>showAuth('login');

    // Show/Hide passwords
    q('#toggleLoginPwd').onclick = ()=>{
      const i=q('#loginPassword'); i.type = i.type==='password'?'text':'password';
    };
    q('#toggleRegPwd').onclick = ()=>{
      const i=q('#regPassword'); i.type = i.type==='password'?'text':'password';
    };

    // Forgot password
    q('#forgotBtn').onclick = async ()=>{
      const email = q('#loginEmail').value.trim();
      if(!email){ toast('Enter your email first'); return; }
      try{ await auth.sendPasswordResetEmail(email); toast('Password reset link sent ‚úî'); }
      catch(e){ toast('Reset failed: '+e.message); }
    };

    // Login
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email=q('#loginEmail').value.trim();
      const pwd=q('#loginPassword').value;
      try{
        await auth.signInWithEmailAndPassword(email,pwd);
        toast('Welcome back!');
      }catch(err){ toast('Login failed: '+err.message); }
    });

    // Register
    registerForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name=q('#regName').value.trim();
      const email=q('#regEmail').value.trim();
      const pwd=q('#regPassword').value;
      try{
        const cred = await auth.createUserWithEmailAndPassword(email,pwd);
        await cred.user.updateProfile({ displayName:name });
        toast('Account created ‚úî');
      }catch(err){ toast('Register failed: '+err.message); }
    });

    // Logout
    q('#logoutBtn').onclick = ()=> auth.signOut();

    // Auth state
    auth.onAuthStateChanged(async (u)=>{
      currentUser = u;
      if(u){
        hideAuth();
        q('#userEmail').textContent = u.email;
        q('#userBadge').classList.remove('hidden');
        q('#logoutBtn').classList.remove('hidden');
        loadPuzzles();
        buildBoard();
      }else{
        showAuth('login');
        q('#userBadge').classList.add('hidden');
        q('#logoutBtn').classList.add('hidden');
      }
    });

    // =========== Tabs outside auth ===========
    qa('.tab-btn').forEach(b=> b.onclick=()=> setTabs(b.dataset.tab));

    // =========== Dashboard (list & open) ===========
    const grid = q('#puzzleGrid');
    let allPuzzles = [];

    async function loadPuzzles(){
      const snap = await db.collection('puzzles').orderBy('createdAt','desc').get().catch(()=>null);
      allPuzzles = [];
      if(snap) snap.forEach(d=> allPuzzles.push({id:d.id, ...d.data()}));
      renderPuzzleGrid();
    }

    function renderPuzzleGrid(){
      const term = q('#searchInput').value.trim().toLowerCase();
      const filter = q('#filterHasSolutions').value;
      grid.innerHTML = '';
      allPuzzles
        .filter(p=> !term || (p.title||'').toLowerCase().includes(term) || (p.description||'').toLowerCase().includes(term))
        .filter(p=> filter==='any' || String(!!p.hasSolutions)===filter)
        .forEach((p)=>{
          const el = document.createElement('div');
          el.className = 'glass neon-ring rounded-2xl p-4 hover:bg-white/5 transition';
          el.innerHTML = `
            <div class="flex items-start justify-between">
              <div>
                <h3 class="text-lg font-semibold">${p.title||'Untitled'}</h3>
                <p class="text-sm opacity-80">${p.description||''}</p>
              </div>
              <span class="text-xs px-2 py-1 rounded-lg ${p.hasSolutions?'bg-emerald-500/20 text-emerald-300':'bg-amber-500/20 text-amber-300'}">${p.hasSolutions?'Has solutions':'No solutions'}</span>
            </div>
            <div class="mt-3 flex items-center justify-between text-sm opacity-80">
              <div>First move: <b>${p.firstMove||'-'}</b></div>
              <button class="glass px-3 py-2 rounded-lg">Open</button>
            </div>`;
          el.querySelector('button').onclick = ()=> openPuzzle(p);
          grid.appendChild(el);
        });
    }

    q('#refreshBtn').onclick = loadPuzzles;
    q('#searchInput').oninput = renderPuzzleGrid;
    q('#filterHasSolutions').onchange = renderPuzzleGrid;

    async function openPuzzle(p){
      activePuzzle = p;
      setTabs('solve');
      // Load FEN or board map
      let fen = p.fen || p.FEN || null;
      if(!fen && p.board){
        fen = boardMapToFEN(p.board, p.firstMove==='b'?'b':'w');
      }
      if(!fen){
        fen = 'startpos';
      }
      if(fen==='startpos'){ chess.reset(); }
      else { try{ chess.load(fen); }catch{ chess.reset(); } }
      userMoves = [];
      startTs = Date.now();
      q('#solveTitle').textContent = p.title||'';
      q('#solveDesc').textContent = p.description||'';
      q('#solveFirstMove').textContent = p.firstMove||'-';
      updateBoard();
      renderMoveList();
      q('#solveStatus').textContent = '';
    }

    function boardMapToFEN(map, turn='w'){
      // map: {"e2":"wp","e7":"bp"} where p=rnbqkp (lowercase black?) We'll accept wp/bp etc
      const pieceFrom = (v)=>{
        const m = String(v||'').toLowerCase();
        const color = m.includes('b')? 'b':'w';
        const code = m.replace(/[^prnbqk]/g,'').slice(-1) || 'p';
        const symbol = code;
        return color==='w' ? symbol.toUpperCase() : symbol;
      }
      const files = ['a','b','c','d','e','f','g','h'];
      let rows=[];
      for(let r=8;r>=1;r--){
        let row=''; let empt=0;
        for(let f=0; f<8; f++){
          const sq = files[f]+r;
          if(map && map[sq]){ if(empt){ row+=empt; empt=0; } row+= pieceFrom(map[sq]); }
          else{ empt++; }
        }
        if(empt) row+=empt;
        rows.push(row);
      }
      return rows.join('/')+' '+turn+' - - 0 1';
    }

    // =========== Board Rendering & Play ===========
    const boardEl = q('#board');
    const moveListEl = q('#moveList');
    const turnTag = q('#turnTag');

    function buildBoard(){
      boardEl.innerHTML='';
      for(let r=8;r>=1;r--){
        for(let f=0; f<8; f++){
          const i=(r+f)%2; // 0 dark, 1 light but we want a1 dark -> (1+1)%2=0 ok
          const div = document.createElement('div');
          div.className = `sq ${i? 'light':'dark'}`;
          div.dataset.sq = 'abcdefgh'[f]+r;
          div.onclick = onSquareClick;
          boardEl.appendChild(div);
        }
      }
      updateBoard();
    }

    function pieceToChar(p){
      const map={p:'‚ôü',r:'‚ôú',n:'‚ôû',b:'‚ôù',q:'‚ôõ',k:'‚ôö'};
      if(!p) return '';
      const s = map[p.type];
      return p.color==='w'? s.replace('‚ôú','‚ôñ').replace('‚ôû','‚ôò').replace('‚ôù','‚ôó').replace('‚ôõ','‚ôï').replace('‚ôö','‚ôî').replace('‚ôü','‚ôô') : s;
    }

    function updateBoard(){
      if(!boardEl.children.length) buildBoard();
      qa('.sq', boardEl).forEach(el=>{ el.textContent=''; el.classList.remove('sel','move'); });
      chess.SQUARES.forEach(sq=>{
        const piece = chess.get(sq);
        if(piece){ const el = qa('.sq', boardEl).find(d=>d.dataset.sq===sq); if(el) el.textContent = pieceToChar(piece); }
      });
      turnTag.textContent = chess.turn()==='w'?'White':'Black';
    }

    let selectedSq=null;
    function onSquareClick(e){
      const sq = e.currentTarget.dataset.sq;
      if(selectedSq===sq){ selectedSq=null; updateHighlights(); return; }
      if(selectedSq){
        const moves = chess.moves({square:selectedSq, verbose:true});
        const mv = moves.find(m=> m.to===sq);
        if(mv){
          chess.move({from:selectedSq, to:sq, promotion:'q'});
          userMoves.push(mv.san);
          updateBoard();
          renderMoveList();
          updateHighlights();
        } else {
          selectedSq = sq; updateHighlights();
        }
      } else {
        selectedSq = sq; updateHighlights();
      }
    }

    function updateHighlights(){
      qa('.sq', boardEl).forEach(el=> el.classList.remove('sel','move'));
      if(!selectedSq) return;
      const el = qa('.sq', boardEl).find(d=>d.dataset.sq===selectedSq);
      if(el){ el.classList.add('sel'); }
      const moves = chess.moves({square:selectedSq, verbose:true});
      moves.forEach(m=>{
        const t = qa('.sq', boardEl).find(d=>d.dataset.sq===m.to); if(t) t.classList.add('move');
      });
    }

    function renderMoveList(){
      moveListEl.innerHTML='';
      userMoves.forEach((m,i)=>{
        const tag = document.createElement('span');
        tag.className = 'glass rounded-lg px-2 py-1';
        tag.textContent = ((i%2===0)? (Math.floor(i/2)+1)+'. ': '') + m;
        moveListEl.appendChild(tag);
      });
    }

    q('#undoBtn').onclick = ()=>{ const mv = chess.undo(); if(mv){ userMoves.pop(); updateBoard(); renderMoveList(); }}
    q('#resetBtn').onclick = ()=>{ if(activePuzzle){ openPuzzle(activePuzzle); }}

    // Check solution
    q('#checkBtn').onclick = async ()=>{
      if(!activePuzzle){ toast('Open a puzzle first'); return; }
      const target = (activePuzzle.solutions && activePuzzle.solutions.length)? activePuzzle.solutions : [];
      // Normalize both to SAN by replaying on a clean game from puzzle start
      const ok = await compareToSolutionSAN(userMoves, target, activePuzzle);
      const took = Math.round((Date.now()- (startTs||Date.now()))/1000);
      q('#solveStatus').textContent = ok? `‚úî Correct in ${took}s` : '‚úñ Not matching saved solution';
      // Save result
      if(currentUser){
        await db.collection('results').add({
          puzzleId: activePuzzle.id || activePuzzle.puzzleId || null,
          userId: currentUser.uid,
          userEmail: currentUser.email,
          correct: !!ok,
          timeSec: took,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(()=>{});
      }
      toast(ok? 'Bravo!': 'Try again');
    };

    async function compareToSolutionSAN(userSAN, storedList, puzzle){
      // Accept comma-separated string or array; allow UCI too
      const sol = (Array.isArray(storedList)? storedList : String(storedList||'').split(',').map(s=>s.trim()).filter(Boolean));
      if(sol.length===0) return false;
      // Build base position from puzzle
      let base = new Chess();
      if(puzzle.fen || puzzle.FEN){ try{ base.load(puzzle.fen || puzzle.FEN); }catch{ base.reset(); } }
      else if(puzzle.board){ try{ base.load(boardMapToFEN(puzzle.board, puzzle.firstMove==='b'?'b':'w')); }catch{ base.reset(); } }
      // Convert solution items to SAN by playing them
      const toSAN = (list)=>{
        const clone = new Chess(base.fen());
        const out=[];
        for(const mv of list){
          let san=null;
          // If looks like UCI (e2e4), try from-to
          if(/^([a-h][1-8]){2}[qrbn]?$/i.test(mv)){
            const from = mv.slice(0,2), to = mv.slice(2,4), promo = mv.slice(4);
            const m = clone.move({from,to,promotion: promo||'q'});
            if(!m) return null; san=m.san; else{};
          } else {
            const m = clone.move(mv); // assume SAN
            if(!m) return null; san=m.san;
          }
          out.push(san);
        }
        return out;
      };
      const solSAN = toSAN(sol);
      if(!solSAN) return false;
      // Compare prefixes: full exact match only
      if(userSAN.length !== solSAN.length) return false;
      for(let i=0;i<solSAN.length;i++){ if(userSAN[i]!==solSAN[i]) return false; }
      return true;
    }

    // =========== Create Puzzle ===========
    q('#createForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); if(!currentUser){ toast('Login first'); return; }
      const title = q('#cTitle').value.trim();
      const description = q('#cDesc').value.trim();
      const firstMove = (q('#cFirstMove').value.trim()||'w').toLowerCase();
      const fen = q('#cFEN').value.trim();
      const boardMapTxt = q('#cBoardMap').value.trim();
      const hasSolutions = q('#cHasSolutions').checked;
      const solutions = q('#cSolutions').value.split(',').map(s=>s.trim()).filter(Boolean);
      let board=null; if(boardMapTxt){ try{ board = JSON.parse(boardMapTxt); }catch{ toast('Invalid board map JSON'); return; } }
      const doc = { title, description, firstMove, hasSolutions, solutions, createdBy: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
      if(fen) doc.fen = fen; if(board) doc.board = board; if(hasSolutions) doc.hasSolutions = true;
      try{
        const ref = await db.collection('puzzles').add(doc);
        q('#createMsg').textContent = `Saved ‚úî ID: ${ref.id}`;
        // Also save to subcollection solutions if provided
        if(solutions.length){
          await db.collection('puzzles').doc(ref.id).collection('solutions').add({ moves: solutions, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          // and mirror to top-level 'solutions' for compatibility
          await db.collection('solutions').add({ puzzleId: ref.id, moves: solutions, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        }
        loadPuzzles();
        toast('Puzzle created');
        e.target.reset();
      }catch(err){ q('#createMsg').textContent = 'Error: '+err.message; }
    });

    // =========== Leaderboard ===========
    q('#refreshLb').onclick = buildLeaderboard;
    async function buildLeaderboard(){
      const snap = await db.collection('results').get().catch(()=>null);
      const stats = new Map(); // userEmail -> {count, time}
      if(snap) snap.forEach(d=>{ const r=d.data(); if(r.correct){ const k=r.userEmail||r.userId; if(!stats.has(k)) stats.set(k,{count:0,time:0,n:0}); const o=stats.get(k); o.count++; o.time+=(r.timeSec||0); o.n++; }});
      const arr = Array.from(stats.entries()).map(([user, o])=>({user, solved:o.count, avg: o.n? Math.round(o.time/o.n): 0})).sort((a,b)=> b.solved-a.solved);
      const body = q('#lbBody'); body.innerHTML='';
      arr.forEach((r,i)=>{
        const tr = document.createElement('tr'); tr.className='border-t border-white/10';
        tr.innerHTML = `<td class="py-2 pr-4">${i+1}</td><td class="py-2 pr-4">${r.user}</td><td class="py-2 pr-4">${r.solved}</td><td class="py-2 pr-4">${r.avg}</td>`;
        body.appendChild(tr);
      })
      if(arr.length===0){ q('#lbBody').innerHTML = '<tr><td colspan="4" class="py-3 opacity-70">No results yet.</td></tr>'; }
    }

    // =========== Admin: attach solution to existing puzzle ===========
    q('#solutionForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const pid = q('#sPuzzleId').value.trim();
      const moves = q('#sMoves').value.split(',').map(s=>s.trim()).filter(Boolean);
      if(!pid || !moves.length){ toast('Provide puzzle ID and moves'); return; }
      try{
        await db.collection('puzzles').doc(pid).update({ hasSolutions: true, solutions: moves });
        await db.collection('puzzles').doc(pid).collection('solutions').add({ moves, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        await db.collection('solutions').add({ puzzleId: pid, moves, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        toast('Solution attached ‚úî');
      }catch(err){ toast('Failed: '+err.message); }
    });

    // =========== Initial ===========
    setTabs('dashboard');
  </script>
</body>
</html>
